$(function(){var t=function(){this.commentList=$(".comment-list"),this.addCommentBtn=$(".comment-btn"),this.activityList=$(".activity-list"),this.movieid=$("#c-mid").val(),this.triggerComment=$("#trigger-comment"),this.chatField=$(".inputMessage"),this.publishActv=$(".publish-actv"),this.likeBtn=$("#like-movie"),this.disLikeBtn=$("#dislike-movie"),this.addCommentForm=$("#add-comment-form")};t.prototype.initCommentForm=function(){$.get("/comment/"+this.movieid,function(t,i){t.status&&$('#add-comment-form input[name="_csrf"]').val(t.csrfToken)})},t.prototype.initScrollBar=function(){$(".chat-bg aside").slimscroll({height:"85%"}),this.activityList.slimscroll({height:"280px"})},t.prototype.bindEvent=function(){var t=this;this.triggerComment.on("click",function(){$.get("/judgeState",function(i){i.loginState?t.triggerComment.attr("data-toggle","comment-modal"):($("#login-modal").foundation("open"),t.triggerComment.attr("data-toggle","comment-modal"))})}),this.publishActv.on("click",function(i){$.get("/judgeState",function(i){i.loginState?location.href="/addactivity/"+t.movieid:$("#login-modal").foundation("open")})}),this.likeBtn.on("click",function(){$.post("/likemovie",{movieid:t.movieid},function(t){t.status?$("#like-movie span").html(t.lknum):$(".add-like-tip").html(t.info)})}),this.disLikeBtn.on("click",function(){$.post("/dislikemovie",{movieid:t.movieid},function(t){t.status?$("#dislike-movie span").html(t.dislknum):$(".add-like-tip").html(t.info)})}),this.addCommentBtn.on("click",function(){var i={title:$('#add-comment-form input[name="title"]').val(),movieid:t.movieid,detail:$("#add-comment-form textarea").val(),_csrf:$('#add-comment-form input[name="_csrf"]').val()};return""==i.title||""==i.detail?void $("#add-comment-form .comment-tip").html("数据不完整"):void $.post("/addcomment",i,function(i){if(i.status){$("#comment-modal").foundation("close"),t.initCommentForm(),t.addCommentForm.children("input").val(""),t.commentList.children("h5").after('<li class="comment-item has-submenu is-accordion-submenu-parent" aria-haspopup="true"><a href="javascript:void(0);" class="default-blue success callout"><img class="avator-small" src="'+i.data.avator+'" alt=""/>'+i.data.content.title+'</a><h6><a href="javascript:void(0)">'+i.data.rel_user+'</a><small class="subheader">&nbsp;发表于: 刚刚</small></h6><p class="gener hide">'+i.data.content.detail.substr(0,80)+'<span>......</span></p><ul class="menu vertical nested submenu is-accordion-submenu" data-submenu aria-hidden="true"><li>'+i.data.content.detail+"</li></ul></li>");var e=parseInt($(".badge").html(),10)+1;$(".badge").html(e)}else $("#add-comment-form .comment-tip").html(i.info)})}),this.commentList.on("click",".comment-item",function(){$(this).children(".gener").toggleClass("hide")})},t.prototype.getActivity=function(){var t=this;$.post("/getrelactivity",{movieid:t.movieid},function(i){if(i&&i.status)for(var e=0;e<i.rel_actv.length;e++)t.activityList.append('<div class="callout success small"><a href="/activity/'+i.rel_actv[e].acid+'"><h6>'+i.rel_actv[e].theme+'</h6></a><small class="subheader">时间:&nbsp;'+i.rel_actv[e].date+"</small></div>")})},t.prototype.setLocalStorage=function(){var t=$("#storage-nickname").val()||$("#storage-name").val(),i=$("#storage-avator").val();t&&i&&window.sessionStorage&&(sessionStorage.setItem("name",t),sessionStorage.setItem("avator",i))},t.prototype.init=function(){this.bindEvent(),this.getActivity(),this.setLocalStorage(),this.initCommentForm(),this.initScrollBar()};var i=new t;i.init()});